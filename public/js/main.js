"use strict";


const socket = io(window.location.origin.replace("http", "ws"));
let loaded = false, gameOptions;
window.onload = _ => {
	loaded = true;
	window.menu = new Menu(socket);
	if (!window.chrome)
		displayToast("This website is best viewed in a chromium based browser");
	if (gameOptions)
		startGame(gameOptions);
};

socket.on("ready", version => {
	const refreshNow = localStorage.version && localStorage.version != version;
	localStorage.version = version;
	if (refreshNow) {
		console.warn("browser cache outdated, refreshing");
		window.location.reload(true);
	}
	socket.emit("uuid", localStorage.uuid);
});
socket.on("uuid-new", uuid => {
	localStorage.uuid = uuid;
	loadMatchMaking();
});
socket.on("uuid-ok", _ => {
	loadMatchMaking();
});

function loadMatchMaking() {
	if (!loaded)
		return setTimeout(loadMatchMaking, 20);
	window.menu.connectedOnline();
}
socket.on("disconnect", _ => {
	window.menu.disconnectedOnline();
});

socket.on("game-launch", (options, me) => {
	options.isOnline = true;
	startGame(options, me);
});
function startGame(options, me) {
	if (!loaded)
		return gameOptions = options || {};
	if (window.game)
		window.game.destroy();
	window.menu.el.setAttribute("hidden", "");
	if (options.isOnline && window.location.pathname != "/" + options.shortCode)
		window.history.pushState(options.shortCode, "", "/" + options.shortCode);
	window.game = new ClientGame(document.body, options, options.isOnline && socket, me);
}

window.onpopstate = e => location.reload(); // TODO: proper way, this will do for now tho

socket.on("generic-error", error => {
	console.error(error);
	alert(error);
});

gameOptions = {
  public: false,
  time: {start:[-1,-1]},
  players: [{name: "you", side: 0}, {name: "you", side: 1}],
};
function v2c(v){
  return [v.l,v.t,v.x,v.y]
}
function c2v(c){
  return new Vec4(c[2],c[3],c[0],c[1]);
}


function mkMoves (mss){
  let result = []
  for(let ms of mss){
    let r=[]
    for (let m of ms) r.push({from:c2v(m[0]), to:c2v(m[1])})
    result.push(r)
  }
  return result
}

gameOptions.moves = mkMoves([
[[[0,0,6,7],[0,0,4,7]]],
[[[0,1,1,7],[0,1,3,7]]],
[[[0,2,7,7],[0,2,5,7]]],
[[[0,3,0,7],[0,3,2,7]]],
[[[0,4,5,7],[0,4,5,0]]],
[[[0,5,2,7],[0,5,2,6]]],
[[[0,6,5,0],[0,6,1,0]]],
[[[0,7,2,6],[0,7,6,6]]],
[[[0,8,1,0],[0,8,1,1]]],
[[[0,9,6,6],[0,9,7,6]]],
[[[0,10,1,1],[0,10,0,1]]],
[[[0,11,7,6],[0,11,6,6]]],
[[[0,12,0,1],[0,12,0,2]]],
[[[0,13,6,6],[0,13,6,5]]],
[[[0,14,7,5],[0,14,6,6]]],
[[[0,15,6,5],[0,15,6,6]]],
[[[0,16,0,2],[0,16,1,2]]],
[[[0,17,6,6],[0,17,6,4]]],
[[[0,18,7,4],[0,18,7,5]]],
[[[0,19,6,4],[0,19,6,3]]],
[[[0,20,1,2],[0,20,1,3]]],
[[[0,21,0,3],[0,21,1,2]]],
[[[0,22,1,3],[0,22,1,2]]],
[[[0,23,6,3],[0,23,7,3]]],
[[[0,24,7,5],[0,24,6,6]]],
[[[0,25,7,3],[0,25,7,2]]],
[[[0,26,1,2],[0,26,1,4]]],
[[[0,27,0,4],[0,27,0,3]]],
[[[0,28,1,4],[0,28,1,5]]],
[[[0,29,7,2],[0,29,7,1]]],
[[[0,30,1,5],[0,30,0,5]]],
[[[0,31,0,3],[0,31,1,2]]],
[[[0,32,0,5],[0,32,0,6]]],
[[[0,33,7,1],[0,33,6,1]]],
[[[0,34,0,6],[0,34,1,6]]],
[[[0,35,1,2],[0,35,2,3]]],
[[[0,36,1,6],[0,36,1,7]]],
[[[0,37,6,1],[0,37,6,0]]],
[[[0,38,1,7],[0,38,3,7]]],
[[[0,39,6,0],[0,39,6,2]]],
[[[0,40,6,6],[0,40,7,7]]],
[[[0,41,6,2],[0,41,4,2]]],
[[[0,42,7,7],[0,42,7,6]]],
[[[0,43,4,2],[0,43,4,7]]],
[[[0,44,7,6],[0,42,7,6]]],
[[[1,43,4,2],[1,43,4,7]],[[0,45,2,3],[0,45,2,4]]],
[[[1,44,7,7],[1,44,6,6]]],
[[[1,45,4,7],[1,45,5,7]]],
[[[1,46,3,7],[1,46,3,6]],[[0,46,3,7],[0,46,3,6]]],
[[[0,47,2,4],[0,47,2,5]],[[1,47,5,7],[0,47,5,7]]],
[[[-1,48,3,6],[-1,48,7,6]],[[1,48,3,6],[1,48,5,6]],[[0,48,3,6],[0,48,7,6]]],
[[[1,49,2,3],[1,49,3,4]],[[0,49,4,7],[0,49,3,7]],[[-1,49,2,4],[-1,49,3,3]]],
[[[-1,50,7,6],[-1,48,7,6]]],
[[[2,49,2,4],[2,49,2,5]]],
[[[1,50,5,6],[1,50,5,0]],[[2,50,3,6],[2,50,6,6]],[[0,50,7,6],[0,50,7,4]]],
[[[0,51,2,5],[0,51,1,6]],[[1,51,3,4],[1,51,2,5]],[[2,51,4,7],[2,51,0,7]],[[-1,51,4,7],[-1,51,3,7]]],
[[[0,52,7,4],[0,52,7,1]],[[-1,52,7,0],[-1,52,6,0]],[[1,52,7,6],[1,52,7,7]],[[2,52,6,6],[2,52,6,0]]],
[[[-1,53,3,7],[-1,49,3,7]]],
[[[-2,50,7,0],[-2,50,6,0]],[[-1,54,6,0],[-1,54,7,0]]],
[[[-2,51,2,4],[-2,51,3,3]],[[-1,55,5,7],[-1,55,5,2]]],
[[[-2,52,6,0],[-2,52,6,6]],[[-1,56,7,0],[-1,56,7,7]]],
[[[0,53,3,7],[0,53,0,7]],[[-1,57,5,2],[-1,49,5,2]]],
[[[-3,50,7,0],[-3,50,7,5]]],
[[[1,53,2,5],[1,53,1,6]],[[2,53,2,5],[2,53,3,4]],[[-3,51,2,4],[-3,51,3,3]]],
[[[-3,52,7,5],[-3,52,3,5]]],
[[[-2,53,3,3],[-2,53,4,2]],[[-3,53,3,3],[-3,53,4,2]]],
[[[-3,54,7,6],[-3,54,3,6]],[[1,54,5,0],[1,54,5,2]],[[2,54,7,6],[0,54,7,6]],[[-2,54,6,6],[0,54,6,6]]],
[[[-3,55,4,2],[-3,55,5,1]],[[-2,55,3,7],[-2,55,3,0]],[[1,55,1,6],[1,55,0,7]],[[2,55,5,7],[2,55,1,7]],[[3,55,1,6],[3,55,1,7]],[[0,55,1,6],[0,55,1,7]]],
[[[-2,56,7,6],[-2,56,6,6]],[[0,56,7,1],[0,56,6,1]],[[3,56,6,6],[3,56,6,5]],[[-3,56,3,6],[-3,56,5,6]],[[1,56,7,7],[2,56,7,6]]],
[[[2,57,0,7],[2,57,0,1]],[[0,57,0,7],[0,57,0,1]],[[1,57,0,0],[1,57,0,1]],[[-3,57,5,1],[-3,57,5,0]],[[-2,57,4,7],[-2,57,4,4]],[[3,57,1,7],[3,57,1,6]]],
[[[0,58,6,1],[0,58,6,5]],[[2,58,6,0],[2,58,6,2]],[[1,58,5,2],[1,58,5,6]],[[3,58,7,0],[3,58,3,0]],[[-2,58,6,6],[-2,58,7,6]],[[-3,58,3,5],[-1,58,3,5]]],
[[[-3,59,5,0],[-3,59,6,1]],[[-2,59,4,4],[-2,59,3,4]],[[-1,59,3,3],[-1,59,2,4]],[[0,59,0,1],[0,59,0,2]],[[1,59,0,1],[1,59,0,0]],[[2,59,3,4],[2,59,2,4]],[[3,59,0,7],[3,59,0,1]]],
[[[-3,60,5,6],[-3,60,4,6]],[[-2,60,7,6],[-2,60,6,6]],[[-1,60,3,5],[-1,60,3,0]],[[0,60,7,6],[0,60,7,5]],[[1,60,5,6],[1,60,5,5]],[[2,60,6,2],[2,60,5,2]],[[3,60,3,0],[3,60,3,4]]],
[[[-3,61,4,7],[-3,61,0,7]],[[-2,61,3,0],[-2,61,7,0]],[[-1,61,2,4],[-1,61,1,5]],[[0,61,1,7],[0,61,0,6]],[[1,61,0,0],[1,61,0,1]],[[2,61,1,7],[2,61,1,0]],[[3,61,0,0],[3,61,7,0]]],
[[[-3,62,4,6],[-3,62,7,6]],[[-2,62,6,6],[-2,62,7,6]],[[-1,62,7,7],[-1,62,7,5]],[[0,62,7,0],[0,62,7,4]],[[1,62,6,6],[1,62,6,5]],[[2,62,7,0],[2,62,6,0]],[[3,62,3,4],[3,62,5,4]]],
[[[-3,63,5,7],[-3,63,1,7]],[[-2,63,5,7],[-2,63,0,7]],[[-1,63,1,5],[-1,63,0,6]],[[0,63,0,2],[0,63,5,2]],[[1,63,0,1],[1,63,0,0]],[[2,63,0,1],[2,63,0,2]],[[3,63,7,0],[3,59,7,0]]],
[[[-4,60,3,0],[-4,60,3,4]],[[-3,64,7,6],[-3,64,6,6]],[[-2,64,7,6],[-2,64,4,6]],[[-1,64,3,0],[-1,64,3,6]],[[0,64,6,5],[0,64,6,6]],[[1,64,5,5],[1,64,5,7]],[[2,64,6,0],[2,64,2,0]],[[3,64,7,1],[3,64,7,6]]],
[[[-4,61,0,7],[-4,61,0,1]],[[-3,65,6,1],[-3,65,7,0]],[[-2,65,4,2],[-2,65,5,2]],[[1,65,0,7],[1,65,0,6]],[[2,65,2,4],[2,65,3,4]]],
[[[-4,62,7,1],[-4,62,5,1]],[[-3,66,6,6],[-3,66,6,7]],[[-2,66,4,6],[-2,66,4,7]],[[1,66,5,7],[1,66,7,7]],[[2,66,2,0],[2,66,7,0]]],
[[[-4,63,1,6],[-4,63,0,6]],[[-3,67,0,0],[-3,67,0,1]],[[-2,67,0,0],[-2,67,0,1]],[[1,67,0,0],[1,67,0,1]],[[2,67,0,0],[2,67,0,1]]],
[[[-4,64,5,1],[-4,64,5,6]]],
[[[-4,65,0,6],[-4,65,0,7]],[[-1,65,0,6],[-1,65,0,7]],[[0,65,0,6],[0,65,0,7]],[[3,65,1,6],[3,65,0,7]]],
[[[-4,66,6,5],[-4,66,6,7]],[[-1,66,7,5],[-1,66,7,7]],[[0,66,7,5],[0,66,7,7]],[[3,66,6,5],[3,66,6,7]]],
  /*
  [[[0,0,6,2],[0,0,5,2]]],
  [[[0,1,1,3],[0,1,3,3]]],
  [[[0,2,7,3],[0,2,5,1]]],
  [[[0,3,3,3],[0,3,4,3]]],
  [[[0,4,7,6],[0,4,5,7]]],
  [[[0,5,0,6],[0,5,2,7]]],
  [[[0,6,5,7],[0,6,7,6]]],
  [[[0,7,2,7],[0,7,0,6]]],
  [[[0,8,7,6],[0,8,5,7]]],
  [[[0,9,0,6],[0,9,2,7]]],
  [[[0,10,5,7],[0,10,7,6]]],
  [[[0,11,0,3],[0,11,2,3]]],*/
])